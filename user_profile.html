<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Profile - ESDC</title>
    <meta name="description" content="User profile and challenge progress for Embedded Systems Design Club">
    <link rel="icon" type="image/png" href="icons/logo.png">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>ESDC</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="index.html#about" class="nav-link">About</a></li>
                <li><a href="index.html#projects" class="nav-link">Projects</a></li>
                <li><a href="index.html#team" class="nav-link">Team</a></li>
                <li><a href="index.html#contact" class="nav-link">Contact</a></li>
                <li id="login-nav-item" class="d-none"><a href="login.html" class="nav-link" id="login-btn">Login</a></li>
                <li id="profile-nav-item" class="d-none"><a href="user_profile.html" class="nav-link" id="profile-link">Profile</a></li>
                <li id="logout-nav-item" class="d-none"><a href="#" class="nav-link" id="logout-btn">Logout</a></li>
            </ul>
            <div class="theme-toggle">
                <button id="theme-toggle-btn" class="theme-btn" aria-label="Toggle theme">
                    <span class="theme-icon">ðŸŒ™</span>
                </button>
            </div>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <section class="hero" style="min-height: calc(100vh - 200px); padding: 2rem 0;">
        <div class="container" id="main-content">
        <!-- Loading State -->
        <div id="loading-state" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading profile...</p>
        </div>

        <!-- Login Required State -->
        <div id="login-required" class="about-card text-center py-5 d-none" style="max-width: 500px; margin: 0 auto;">
            <div class="card-icon" style="font-size: 4rem;">ðŸ‘¤</div>
            <h3 class="mt-3">Login Required</h3>
            <p>Please log in to view your profile and challenge progress.</p>
            <button class="btn btn-primary" onclick="window.location.href='login.html'">Login with GitHub</button>
        </div>

        <!-- Profile Content -->
        <div id="profile-content" class="d-none">
            <div class="row mb-4">
                <div class="col">
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="index.html">Home</a></li>
                            <li class="breadcrumb-item active" id="breadcrumb-username">Profile</li>
                        </ol>
                    </nav>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-person-circle"></i> <span id="profile-username">User</span>'s Profile
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <img id="profile-avatar" src="" alt="Profile"
                                     class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover;">
                                <div>
                                    <h5 class="mb-1" id="profile-name">User</h5>
                                    <a id="github-profile-link" href="#" target="_blank" class="text-decoration-none">
                                        <i class="bi bi-github"></i> GitHub Profile
                                    </a>
                                </div>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="text-muted">Repository synchronization:</span>
                                <button id="refresh-btn" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-arrow-clockwise"></i> Sync with Repo
                                </button>
                            </div>

                            <div class="progress mb-3" style="height: 25px;">
                                <div class="progress-bar bg-success" id="progress-bar"
                                     role="progressbar" style="width: 0%;"
                                     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                    <span id="progress-text">0/0 Challenges Completed</span>
                                </div>
                            </div>

                            <div class="row text-center mt-4">
                                <div class="col-4">
                                    <div class="p-3 border rounded mb-2">
                                        <h3 class="mb-0" id="solved-count">0</h3>
                                    </div>
                                    <span class="text-muted">Solved</span>
                                </div>
                                <div class="col-4">
                                    <div class="p-3 border rounded mb-2">
                                        <h3 class="mb-0" id="beginner-count">0</h3>
                                    </div>
                                    <span class="text-success">Beginner</span>
                                </div>
                                <div class="col-4">
                                    <div class="p-3 border rounded mb-2">
                                        <h3 class="mb-0" id="advanced-count">0</h3>
                                    </div>
                                    <span class="text-danger">Advanced</span>
                                </div>
                            </div>

                            <div class="mt-3" id="git-repo-section" style="display: none;">
                                <a id="git-repo-link" href="#" target="_blank" class="btn btn-outline-primary d-block">
                                    <i class="bi bi-git"></i> View Git Repository
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card shadow-sm mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Challenge Progress</h5>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>#</th>
                                            <th>Challenge</th>
                                            <th>Difficulty</th>
                                            <th>Status</th>
                                            <th>Last Attempt</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="challenges-table">
                                        <!-- Challenges will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="card shadow-sm">
                        <div class="card-header">
                            <h5 class="mb-0">Recent Submissions</h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="submissions-content">
                                <!-- Submissions will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        </div>
    </section>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Homepage JavaScript -->
    <script src="js/script.js"></script>

    <!-- Supabase Configuration -->
    <script>
        // Supabase configuration
        const supabase = window.supabase.createClient(window.SUPABASE_CONFIG.URL, window.SUPABASE_CONFIG.ANON_KEY);

        // DOM elements
        const loadingState = document.getElementById('loading-state');
        const loginRequired = document.getElementById('login-required');
        const profileContent = document.getElementById('profile-content');
        const loginBtn = document.getElementById('login-btn');
        const loginRequiredBtn = document.getElementById('login-required-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const profileNav = document.getElementById('profile-nav');
        const logoutNav = document.getElementById('logout-nav');
        const loginNav = document.getElementById('login-nav');

        // Initialize app
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeAuth();
        });

        async function initializeAuth() {
            try {
                // Check localStorage for GitHub token and user data
                const token = localStorage.getItem('github_token');
                const userData = localStorage.getItem('github_user');

                if (token && userData) {
                    const user = JSON.parse(userData);
                    await loadUserProfile(user);
                    showProfileView();
                } else {
                    showLoginView();
                }
            } catch (error) {
                console.error('Auth initialization error:', error);
                showLoginView();
            }
        }

        function showLoginView() {
            loadingState.classList.add('d-none');
            loginRequired.classList.remove('d-none');
            profileContent.classList.add('d-none');
            loginNav.classList.remove('d-none');
            profileNav.classList.add('d-none');
            logoutNav.classList.add('d-none');
        }

        function showProfileView() {
            loadingState.classList.add('d-none');
            loginRequired.classList.add('d-none');
            profileContent.classList.remove('d-none');
            loginNav.classList.add('d-none');
            profileNav.classList.remove('d-none');
            logoutNav.classList.remove('d-none');
        }

        async function loadUserProfile(user) {
            try {
                // Update profile information
                const username = user.login || user.name || 'User';
                const displayName = user.name || user.login || 'User';
                document.getElementById('profile-username').textContent = displayName;
                document.getElementById('breadcrumb-username').textContent = `Profile: ${displayName}`;
                document.getElementById('profile-name').textContent = displayName;
                document.getElementById('profile-avatar').src = user.avatar_url || `https://github.com/${username}.png`;
                document.getElementById('github-profile-link').href = user.html_url || `https://github.com/${username}`;

                // Load user data
                await loadChallenges();
                await loadSubmissions();

            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        async function loadChallenges() {
            try {
                // This would load challenges from your Supabase database
                // For now, showing placeholder data
                const challenges = [
                    { id: 1, title: 'Basic LED Control', difficulty: 'Beginner', status: 'completed' },
                    { id: 2, title: 'Motor Control System', difficulty: 'Intermediate', status: 'in-progress' },
                    { id: 3, title: 'Advanced Robotics', difficulty: 'Advanced', status: 'not-started' }
                ];

                const challengesTable = document.getElementById('challenges-table');
                challengesTable.innerHTML = challenges.map(challenge => `
                    <tr class="${challenge.status === 'completed' ? 'table-success' : ''}">
                        <td>${challenge.id}</td>
                        <td>${challenge.title}</td>
                        <td>
                            <span class="badge rounded-pill bg-${getDifficultyColor(challenge.difficulty)}">
                                ${challenge.difficulty}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-${getStatusColor(challenge.status)}">${getStatusText(challenge.status)}</span>
                        </td>
                        <td>-</td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="#" class="btn btn-outline-primary">Start</a>
                            </div>
                        </td>
                    </tr>
                `).join('');

                // Update progress stats
                const solved = challenges.filter(c => c.status === 'completed').length;
                const beginner = challenges.filter(c => c.difficulty === 'Beginner' && c.status === 'completed').length;
                const advanced = challenges.filter(c => c.difficulty === 'Advanced' && c.status === 'completed').length;

                document.getElementById('solved-count').textContent = solved;
                document.getElementById('beginner-count').textContent = beginner;
                document.getElementById('advanced-count').textContent = advanced;

                const progressPercent = challenges.length > 0 ? (solved / challenges.length) * 100 : 0;
                document.getElementById('progress-bar').style.width = `${progressPercent}%`;
                document.getElementById('progress-text').textContent = `${solved}/${challenges.length} Challenges Completed`;

            } catch (error) {
                console.error('Error loading challenges:', error);
            }
        }

        async function loadSubmissions() {
            try {
                // This would load submissions from your Supabase database
                const submissionsContent = document.getElementById('submissions-content');

                // Placeholder for no submissions
                submissionsContent.innerHTML = `
                    <div class="p-4 text-center">
                        <p class="text-muted">No submissions yet.</p>
                    </div>
                `;

            } catch (error) {
                console.error('Error loading submissions:', error);
            }
        }

        function getDifficultyColor(difficulty) {
            switch (difficulty) {
                case 'Beginner': return 'success';
                case 'Intermediate': return 'warning';
                case 'Advanced': return 'danger';
                default: return 'secondary';
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'completed': return 'success';
                case 'in-progress': return 'warning';
                case 'not-started': return 'secondary';
                default: return 'secondary';
            }
        }

        function getStatusText(status) {
            switch (status) {
                case 'completed': return 'Completed';
                case 'in-progress': return 'Attempted';
                case 'not-started': return 'Not Started';
                default: return 'Not Started';
            }
        }

        // Login functionality
        async function loginWithGitHub() {
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'github',
                    options: {
                        redirectTo: window.location.origin + '/user_profile.html'
                    }
                });

                if (error) throw error;

            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed: ' + error.message);
            }
        }

        // Logout functionality
        async function logout() {
            try {
                // Clear localStorage
                localStorage.removeItem('github_token');
                localStorage.removeItem('github_user');
                sessionStorage.removeItem('oauth_state');

                showLoginView();
                window.location.href = 'index.html';

            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed: ' + error.message);
            }
        }

        // Event listeners
        loginBtn.addEventListener('click', loginWithGitHub);
        loginRequiredBtn.addEventListener('click', loginWithGitHub);
        logoutBtn.addEventListener('click', logout);

        // Listen for auth state changes
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_IN' && session) {
                await loadUserProfile(session.user);
                showProfileView();
            } else if (event === 'SIGNED_OUT') {
                showLoginView();
            }
        });

        // Refresh button functionality
        document.getElementById('refresh-btn').addEventListener('click', async () => {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Syncing...';

            try {
                // Simulate API call to refresh submissions
                await new Promise(resolve => setTimeout(resolve, 2000));

                alert('Successfully synchronized with repository! Found 0 new submissions.');
                await loadChallenges();
                await loadSubmissions();

            } catch (error) {
                alert('Failed to synchronize with repository: ' + error.message);
            } finally {
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Sync with Repo';
            }
        });
    </script>
</body>

</html> 