<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - ESDC</title>
    <meta name="description" content="Login to Embedded Systems Design Club platform">
    <link rel="icon" type="image/png" href="icons/logo.png">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/style.css">

    <!-- Configuration -->
    <script src="js/config.js"></script>
</head>

<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">
                <h2>ESDC</h2>
            </div>
            <ul class="nav-menu">
                <li><a href="index.html" class="nav-link">Home</a></li>
                <li><a href="index.html#about" class="nav-link">About</a></li>
                <li><a href="index.html#projects" class="nav-link">Projects</a></li>
                <li><a href="index.html#team" class="nav-link">Team</a></li>
                <li><a href="index.html#contact" class="nav-link">Contact</a></li>
                <li id="login-nav-item" class="d-none"><a href="login.html" class="nav-link" id="login-btn">Login</a></li>
                <li id="profile-nav-item" class="d-none"><a href="user_profile.html" class="nav-link" id="profile-link">Profile</a></li>
                <li id="logout-nav-item" class="d-none"><a href="#" class="nav-link" id="logout-btn">Logout</a></li>
            </ul>
            <div class="theme-toggle">
                <button id="theme-toggle-btn" class="theme-btn" aria-label="Toggle theme">
                    <span class="theme-icon">ðŸŒ™</span>
                </button>
            </div>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </div>
    </nav>

    <!-- Login Section -->
    <section class="hero" style="min-height: calc(100vh - 200px); display: flex; align-items: center;">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6 col-lg-5">
                    <div class="about-card" style="padding: 3rem; text-align: center;">
                            <div class="text-center mb-4">
                                <img src="icons/logo.png" alt="ESDC Logo" width="80" height="80" class="mb-3">
                                <h2 class="fw-bold">Welcome Back</h2>
                                <p class="text-muted">Sign in to access your ESDC profile and challenges</p>
                            </div>

                            <!-- Loading State -->
                            <div id="loading-state" class="text-center d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-3 text-muted">Checking authentication...</p>
                            </div>

                            <!-- Already Logged In State -->
                            <div id="authenticated-state" class="text-center d-none">
                                <div class="alert alert-success">
                                    <i class="bi bi-check-circle-fill fs-1 text-success mb-3"></i>
                                    <h5>You are already logged in!</h5>
                                    <p class="mb-3">Welcome back, <span id="user-name">User</span></p>
                                    <div class="d-grid gap-2">
                                        <a href="user_profile.html" class="btn btn-primary">Go to Profile</a>
                                        <button id="logout-btn" class="btn btn-outline-danger">Logout</button>
                                    </div>
                                </div>
                            </div>

                            <!-- Login Form -->
                            <div id="login-form">
                                <div class="d-grid gap-3">
                                    <button id="github-login-btn" class="btn btn-dark btn-lg d-flex align-items-center justify-content-center">
                                        <svg width="20" height="20" viewBox="0 0 24 24" class="me-2">
                                            <path fill="currentColor" d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                                        </svg>
                                        Continue with GitHub
                                    </button>

                                    <div class="text-center">
                                        <small class="text-muted">
                                            By signing in, you agree to our terms of service and privacy policy.
                                        </small>
                                    </div>
                                </div>

                                <!-- Error Message -->
                                <div id="error-message" class="alert alert-danger mt-3 d-none">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    <span id="error-text">Login failed. Please try again.</span>
                                </div>
                            </div>

                            <!-- Features Section -->
                            <div class="mt-5 pt-4 border-top">
                                <h6 class="text-center mb-3">What you can do when logged in:</h6>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="text-center">
                                            <i class="bi bi-person-circle text-primary fs-4 mb-2"></i>
                                            <small class="d-block">View Profile</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <i class="bi bi-trophy text-warning fs-4 mb-2"></i>
                                            <small class="d-block">Track Progress</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <i class="bi bi-code-slash text-success fs-4 mb-2"></i>
                                            <small class="d-block">Access Challenges</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="text-center">
                                            <i class="bi bi-chat-dots text-info fs-4 mb-2"></i>
                                            <small class="d-block">Join Community</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>ESDC</h3>
                    <p>Embedded Systems Design Club<br>Government College of Engineering Kannur</p>
                </div>
                <div class="footer-section">
                    <p>&copy; 2025 ESDC. All rights reserved.</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Homepage JavaScript -->
    <script src="js/script.js"></script>

    <!-- GitHub OAuth Configuration -->
    <script>
        // GitHub OAuth Configuration will be loaded from js/config.js

        // DOM elements
        let loadingState, authenticatedState, loginForm, githubLoginBtn, logoutBtn, errorMessage, errorText, userName;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOM loaded, checking config...');
            console.log('GITHUB_CONFIG available:', !!window.GITHUB_CONFIG);
            if (window.GITHUB_CONFIG) {
                console.log('GITHUB_CONFIG:', window.GITHUB_CONFIG);
            }

            // Get DOM elements
            loadingState = document.getElementById('loading-state');
            authenticatedState = document.getElementById('authenticated-state');
            loginForm = document.getElementById('login-form');
            githubLoginBtn = document.getElementById('github-login-btn');
            logoutBtn = document.getElementById('logout-btn');
            errorMessage = document.getElementById('error-message');
            errorText = document.getElementById('error-text');
            userName = document.getElementById('user-name');

            // Check for OAuth callback
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');

            console.log('URL params - code:', !!code, 'state:', !!state);

            if (code) {
                // Handle OAuth callback
                await handleOAuthCallback(code, state);
            } else {
                // Normal page load
                await checkAuthState();
            }

            // Attach event listeners after DOM is ready
            attachEventListeners();
        });

        function attachEventListeners() {
            // GitHub Login (Real OAuth)
            githubLoginBtn.addEventListener('click', () => {
                console.log('GitHub login button clicked');
                console.log('window.GITHUB_CONFIG:', window.GITHUB_CONFIG);

                if (!window.GITHUB_CONFIG || !window.GITHUB_CONFIG.CLIENT_ID) {
                    console.error('GITHUB_CONFIG not available or missing CLIENT_ID');
                    alert('Configuration error: GitHub OAuth not properly configured');
                    return;
                }

                // Show loading state
                githubLoginBtn.disabled = true;
                githubLoginBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Redirecting...';

                // Generate random state for security
                const state = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
                sessionStorage.setItem('oauth_state', state);

                // Build GitHub OAuth URL
                const authUrl = `https://github.com/login/oauth/authorize?` +
                    `client_id=${encodeURIComponent(window.GITHUB_CONFIG.CLIENT_ID)}&` +
                    `redirect_uri=${encodeURIComponent(window.GITHUB_CONFIG.REDIRECT_URI)}&` +
                    `scope=${encodeURIComponent(window.GITHUB_CONFIG.SCOPE)}&` +
                    `state=${encodeURIComponent(state)}&` +
                    `response_type=code`;

                console.log('Redirecting to:', authUrl);

                // Redirect to GitHub
                window.location.href = authUrl;
            });

            // Logout
            logoutBtn.addEventListener('click', () => {
                // Clear stored authentication data
                localStorage.removeItem('github_token');
                localStorage.removeItem('github_user');
                sessionStorage.removeItem('oauth_state');

                // Reset UI
                checkAuthState();

                alert('Successfully logged out!');
            });
        }

        async function checkAuthState() {
            try {
                loadingState.classList.remove('d-none');
                loginForm.classList.add('d-none');
                authenticatedState.classList.add('d-none');

                // Check if user is authenticated (token exists in localStorage)
                const token = localStorage.getItem('github_token');
                const userData = localStorage.getItem('github_user');

                if (token && userData) {
                    // User is logged in
                    const user = JSON.parse(userData);
                    const displayName = user.name || user.login || 'User';
                    userName.textContent = displayName;
                    authenticatedState.classList.remove('d-none');
                } else {
                    // User needs to log in
                    loginForm.classList.remove('d-none');
                }

                loadingState.classList.add('d-none');
            } catch (error) {
                console.error('Auth check error:', error);
                loadingState.classList.add('d-none');
                loginForm.classList.remove('d-none');
                showError('Failed to check authentication status');
            }
        }

        async function handleOAuthCallback(code, state) {
            console.log('Handling OAuth callback with code:', code, 'state:', state);
            try {
                loadingState.classList.remove('d-none');
                loginForm.classList.add('d-none');
                authenticatedState.classList.add('d-none');

                // Verify state for security
                const storedState = sessionStorage.getItem('oauth_state');
                console.log('Stored state:', storedState, 'Received state:', state);

                if (state !== storedState) {
                    throw new Error('Invalid OAuth state - possible security issue');
                }

                // Exchange code for token
                console.log('Exchanging code for token...');
                const tokenData = await exchangeCodeForToken(code);
                console.log('Token data received:', tokenData);

                // Get user info
                console.log('Getting user info...');
                const user = await getUserInfo(tokenData.access_token);
                console.log('User info received:', user);

                // Store authentication data
                localStorage.setItem('github_token', tokenData.access_token);
                localStorage.setItem('github_user', JSON.stringify(user));

                // Clear URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);

                // Show authenticated state
                const displayName = user.name || user.login || 'User';
                userName.textContent = displayName;
                authenticatedState.classList.remove('d-none');
                loadingState.classList.add('d-none');

            } catch (error) {
                console.error('OAuth callback error:', error);
                loadingState.classList.add('d-none');
                loginForm.classList.remove('d-none');
                showError('Authentication failed: ' + error.message);
            }
        }

        async function exchangeCodeForToken(code) {
            console.log('Using mock authentication for local development');
            
            // For local development, always use mock data
            return {
                access_token: 'mock_token_' + Date.now(),
                token_type: 'bearer'
            };
        }

        async function getUserInfo(token) {
            console.log('Getting mock user info for local development');
            
            // For local development, always return mock data
            return {
                id: 12345,
                login: 'testuser',
                name: 'Test User',
                email: 'test@example.com',
                avatar_url: 'https://github.com/identicons/testuser.png',
                html_url: 'https://github.com/testuser',
                bio: 'Test user for local development',
                company: 'ESDC',
                location: 'Kannur'
            };
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('d-none');
        }


    </script>
</body>

</html>